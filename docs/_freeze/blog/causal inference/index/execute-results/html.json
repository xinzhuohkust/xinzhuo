{
  "hash": "8939b481e6c3b59f532a3707119ca484",
  "result": {
    "markdown": "---\ntitle: \"Causal Inference Practical Methods\"\ndate: \"last-modified\"\nauthor: Xinzhuo HUANG\ncategories: [R, DiD, RD, IV, Causal Inference]\ndescription: \"with R\"\ncode-fold: show\nfeed: true\ncap-location: bottom\n---\n\n```{=html}\n<style>\nbody {text-align: justify}\n</style>\n```\n\n\n# Setup {.unnumbered}\n\n::: {.cell}\n\n```{.r .cell-code}\nrequire(\"pacman\")\n\np_load(\n    tibble, dplyr, furrr, purrr, tidyr, stringr, rio, ggplot2, knitr,\n    broom, kableExtra, lfe, plm, ggthemes, skimr, ggpmisc, sysfonts, \n    extrafont, AER, dagitty, ggdag, rdrobust, rddensity, did\n)\n\nprint_kable <- \\(result, title) {\n    kable(\n        result,\n        digits = 3,\n        caption = title,\n        booktabs = TRUE\n    )\n}\n```\n:::\n\n\n\n# Fixed Effects\n\n## Linear Dummy Variabel Model\n\nFixed effects model shows that the beer tax does reduce fatalities.             \n\n\n::: {.cell}\n\n```{.r .cell-code}\nfatality <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/fatality.csv\",\n    setclass = \"tibble\"\n)\n\nfatality %>% \n    ggplot(aes(x = beertax, y = fatality_rate)) +\n    geom_point(aes(color = state)) +\n    geom_smooth(\n        aes(group = state, color = state),\n        method = \"lm\", \n        se = FALSE\n    ) +\n    geom_smooth(method = \"lm\", linetype = \"dashed\", color = \"#8E8E93\") +\n    xlab(\"Beer Tax\") +\n    ylab(\"Fatalities\") +\n    theme_clean() +\n    theme(\n        panel.border = element_blank(),\n        legend.position = \"none\"\n    )\n```\n\n::: {.cell-output-display}\n![The relationship between the beer tax and fatality](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlinear_dummy_formula <- fatality %>% \n    pull(state) %>% \n    sprintf(\"`%s`\", .) %>% \n    unique() %>% \n    str_c(collapse = \" + \") %>% \n    str_c(\"fatality_rate ~ 0 + beertax + \", ., collapse = \" + \") %>% \n    as.formula()\n\nlinear_dummy <- fatality %>% \n    pivot_wider(\n        names_from = state,\n        values_from = state\n    ) %>% \n    mutate(\n        across(3:50, ~ str_replace(., \"\\\\w+\", \"1\")),\n        across(3:50, ~ replace_na(., \"0\")),\n        across(3:50, as.numeric) \n    ) %>% \n    lm(\n        linear_dummy_formula,\n        data = .\n    ) \n\nlinear_dummy %>% \n    tidy() %>% \n    slice(1) %>% \n    print_kable(title = \"Linear dummy variable model\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Linear dummy variable model</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> beertax </td>\n   <td style=\"text-align:right;\"> -0.656 </td>\n   <td style=\"text-align:right;\"> 0.188 </td>\n   <td style=\"text-align:right;\"> -3.491 </td>\n   <td style=\"text-align:right;\"> 0.001 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Fixed effect in standard packages\n\n::: {.cell}\n\n```{.r .cell-code}\nfixed_effect_plm <- fatality %>% \n    pdata.frame(index = c(\"state\")) %>% \n    plm(\n        fatality_rate ~ beertax, \n        data = ., \n        model = \"within\", \n        effect = \"individual\"\n    ) \n\nfixed_clustered_plm <- fixed_effect_plm %>% \n    tidy() %>% \n    mutate(\n        category = \"fixed effects with plm\",\n        `std.error` = vcovHC(\n            fixed_effect_plm, \n            type = \"HC1\", \n            cluster = \"group\"\n        ) |> \n        diag() |>\n        sqrt(),\n        statistic = coef(fixed_effect_plm) / `std.error`,\n        `p.value` = 2 * pt(\n            abs(statistic), \n            df = fixed_effect_plm$df.residual, \n            lower.tail = FALSE\n        )\n    ) \n\nfixed_clustered_lfe <- fatality %>% \n    felm(\n        fatality_rate ~ beertax | state,\n        cluster = \"state\",\n        data = .\n    ) %>% \n    tidy() %>% \n    mutate(category = \"fixed effects with lfe\")\n\nfixed_clustered_lfe %>% \n    bind_rows(fixed_clustered_plm) %>% \n    print_kable(title = \"Fixed effect in standard packages\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Fixed effect in standard packages</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n   <th style=\"text-align:left;\"> category </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> beertax </td>\n   <td style=\"text-align:right;\"> -0.656 </td>\n   <td style=\"text-align:right;\"> 0.292 </td>\n   <td style=\"text-align:right;\"> -2.247 </td>\n   <td style=\"text-align:right;\"> 0.029 </td>\n   <td style=\"text-align:left;\"> fixed effects with lfe </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> beertax </td>\n   <td style=\"text-align:right;\"> -0.656 </td>\n   <td style=\"text-align:right;\"> 0.289 </td>\n   <td style=\"text-align:right;\"> -2.271 </td>\n   <td style=\"text-align:right;\"> 0.024 </td>\n   <td style=\"text-align:left;\"> fixed effects with plm </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n# DiD\n\n## Pre-trends\n\nBased on the figure, the parallel trend assumption may not hold, as we can see that the crime rates in Muslim/Jewish neighborhoods experienced two episodes of first decreasing, then increasing again, before increasing prior to the intervention. However, the Non Muslim/Jewish only experienced one episodes. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ncartheft <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/cartheft.dta\",\n    setclass = \"tibble\"\n    ) %>% \n    mutate(treatment = if_else(distance > 0, 0, 1)) \n\ncartheft %>% \n    group_by(month, treatment, postattack) %>% \n    summarise(mean = mean(cartheft)) %>% \n    ggplot(\n        aes(x = month, y = mean)\n    ) + \n    geom_line(\n        aes(group = treatment, color = as.factor(treatment)),\n        linewidth = 1.2,\n        linetype = \"twodash\"\n    ) + \n    geom_vline(\n        xintercept = 8, \n        linetype = \"dotdash\",\n        linewidth = 1,\n        color = \"#8E8E93\"\n    ) + \n    theme_clean() + \n    xlab(\"Month\") +\n    ylab(\"Mean crime rates\") +\n    theme(\n        legend.position = \"none\"\n    ) +\n    geom_text(\n        x = 10,\n        y = 0.064,\n        label = \"Muslim/Jewish\",\n        size = 3.6,\n        fontface = \"italic\"\n    ) +\n    geom_text(\n        x = 10,\n        y = 0.112,\n        label = \"Non Muslim/Jewish\",\n        size = 3.6, \n        fontface = \"italic\"\n    ) \n```\n\n::: {.cell-output-display}\n![Pre-trends test](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n## DiD as a linear regression with interaction\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndid_interaction <- cartheft %>% \n    lm(\n        cartheft ~ treatment + postattack + treatment * postattack,\n        data = .\n    ) %>% \n    tidy() %>% \n    slice(4) %>% \n    mutate(term = \"Same-Block Police\") \n\ndid_interaction %>%\n    print_kable(., title = \"linear regression with interaction\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>linear regression with interaction</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Same-Block Police </td>\n   <td style=\"text-align:right;\"> -0.078 </td>\n   <td style=\"text-align:right;\"> 0.027 </td>\n   <td style=\"text-align:right;\"> -2.847 </td>\n   <td style=\"text-align:right;\"> 0.004 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## DiD asd fixed effect\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndid_fixed <- cartheft %>% \n    felm(\n        cartheft ~ treatment * postattack | blockid + month,\n        data = .\n    ) %>% \n    tidy() %>% \n    slice(3) %>% \n    mutate(term = \"Same-Block * Postattack\") \n\ndid_fixed %>%\n    print_kable(title = \"Two way fixed effect model\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Two way fixed effect model</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Same-Block * Postattack </td>\n   <td style=\"text-align:right;\"> -0.078 </td>\n   <td style=\"text-align:right;\"> 0.026 </td>\n   <td style=\"text-align:right;\"> -2.992 </td>\n   <td style=\"text-align:right;\"> 0.003 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Time-invariant variables in fixed effect regressions\n\nWe cannot estimate the coefficient for time-invariant variables since they are absorbed by the individual fixed effects.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndid_fixed_invariant <- cartheft %>% \n    felm(\n        cartheft ~ treatment * postattack + bank | blockid + month,\n        data = .\n    ) %>% \n    tidy() %>% \n    slice(3:4) %>% \n    mutate(term = c(\"Bank\", \"Same-Block * Postattack\"))\n\ndid_fixed_invariant %>%  \n    print_kable(title = \"Time-invariant variables in regression\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Time-invariant variables in regression</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Bank </td>\n   <td style=\"text-align:right;\"> NaN </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NaN </td>\n   <td style=\"text-align:right;\"> NaN </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Same-Block * Postattack </td>\n   <td style=\"text-align:right;\"> -0.078 </td>\n   <td style=\"text-align:right;\"> 0.026 </td>\n   <td style=\"text-align:right;\"> -2.992 </td>\n   <td style=\"text-align:right;\"> 0.003 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n# Instrumental Variable\n\n\\begin{align*}\n\\log(wage) = \\beta_{0} + \\beta_{1}educ\n\\end{align*}\n\n\n\n\\begin{align*}                \neduc = \\gamma_{0} + \\gamma_{1}educ\n\\end{align*}                      \n\n## IV estimate\n\nThe IV estimator is larger than the OLS estimator. Since in this study, IV is used to address endogeneity by providing a source of variation in the predictor variable that is independent of the error term. In that case, IV estimate accounts for endogeneity and provides a more reliable estimate of the true causal effect of the predictor variable on the outcome variable. The OLS estimate, on the other hand, may be biased and inconsistent in the presence of endogeneity, leading to an underestimate of the true effect size.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndag <- tribble(\n    ~name, ~label, ~x, ~y,\n    \"educ\", \"Educ\", 4, 1,\n    \"wage\", \"Wage\", 5, 1,\n    \"e\", \"Confounders\", 4.5, 1.5,\n    \"Z\", \"Instrumental Variable\", 3, 1\n)\n\nnode_labels <- dag$label\nnames(node_labels) <- dag$name\n\nstatus_colors <- c(\n    exposure = \"#00BFFF\", \n    outcome = \"#FF7F50\", \n    latent = \"#D3D3D3\"\n    )\n\ndagify(\n    wage ~ educ + e,\n    educ ~ e,\n    educ ~ Z,\n    exposure = \"educ\",\n    outcome = \"wage\",\n    latent = \"e\",\n    coords = dag,\n    labels = node_labels\n) %>% \ntidy_dagitty() %>% \nnode_status() %>% \nggplot(aes(x = x, y = y, xend = xend, yend = yend)) + \ngeom_dag_edges() +\ngeom_dag_point(aes(color = status)) +\ngeom_dag_label_repel(\n    aes(label = label, fill = status), \n    color = \"white\", \n    fontface = \"bold\"\n) +\nscale_color_manual(values = status_colors, na.value = \"grey20\") +\nscale_fill_manual(values = status_colors, na.value = \"grey20\") +\nguides(color = FALSE, fill = FALSE) + \ntheme_dag()\n```\n\n::: {.cell-output-display}\n![Directed Acyclic Graphs](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncard <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/card.csv\",\n    setclass = \"tibble\"\n    )\n\nols <- card %>% \n    lm(\n        lwage ~ educ,\n        data = . \n    ) %>% \n    coeftest(vcovHC, \"HC1\") %>% \n    tidy() %>% \n    slice(2) %>% \n    mutate(method = \"OLS with robust std.error\")\n\niv <- card %>% \n    ivreg(\n        lwage ~ educ | nearc4,\n        data = .\n    ) %>% \n    coeftest(vcovHC, \"HC1\") %>% \n    tidy() %>% \n    slice(2) %>% \n    mutate(method = \"IV with robust std.error\")\n\nbind_rows(ols, iv) %>%  \n    print_kable(title = \"Comparison between OLS and IV\") \n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Comparison between OLS and IV</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n   <th style=\"text-align:left;\"> method </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> educ </td>\n   <td style=\"text-align:right;\"> 0.052 </td>\n   <td style=\"text-align:right;\"> 0.003 </td>\n   <td style=\"text-align:right;\"> 17.902 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> OLS with robust std.error </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> educ </td>\n   <td style=\"text-align:right;\"> 0.188 </td>\n   <td style=\"text-align:right;\"> 0.026 </td>\n   <td style=\"text-align:right;\"> 7.189 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> IV with robust std.error </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n## Manual 2SLS\n\n::: {.cell}\n\n```{.r .cell-code}\nfirst_stage <- card %>% \n    lm(\n        educ ~ nearc4,\n        data = . \n    ) \n\nmanual <- card %>% \n    mutate(educ = predict(first_stage)) %>% \n    lm(\n        lwage ~ educ,\n        data = .\n    ) %>% \n    coeftest(vcovHC, \"HC1\") %>% \n    tidy() %>% \n    slice(2) %>% \n    mutate(method = \"Manual 2SLS with robust std.error\")\n\nbind_rows(manual, iv, ols) %>% \n    print_kable(title = \"Comparison between OLS, IV and manual 2SLS\") \n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Comparison between OLS, IV and manual 2SLS</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n   <th style=\"text-align:left;\"> method </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> educ </td>\n   <td style=\"text-align:right;\"> 0.188 </td>\n   <td style=\"text-align:right;\"> 0.021 </td>\n   <td style=\"text-align:right;\"> 9.149 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Manual 2SLS with robust std.error </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> educ </td>\n   <td style=\"text-align:right;\"> 0.188 </td>\n   <td style=\"text-align:right;\"> 0.026 </td>\n   <td style=\"text-align:right;\"> 7.189 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> IV with robust std.error </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> educ </td>\n   <td style=\"text-align:right;\"> 0.052 </td>\n   <td style=\"text-align:right;\"> 0.003 </td>\n   <td style=\"text-align:right;\"> 17.902 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> OLS with robust std.error </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Weak instrument\n\nThe F statistics from the first-stage regression is larger than 10.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwaldtest(\n    lm(lwage ~ educ + nearc4, card),\n    lm(lwage ~ educ, card)\n) %>% \ntidy %>% \nrename(F.statistic = statistic) %>% \nprint_kable(title = \"Weak instrument test\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Weak instrument test</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> df.residual </th>\n   <th style=\"text-align:right;\"> df </th>\n   <th style=\"text-align:right;\"> F.statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> lwage ~ educ + nearc4 </td>\n   <td style=\"text-align:right;\"> 3007 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> lwage ~ educ </td>\n   <td style=\"text-align:right;\"> 3008 </td>\n   <td style=\"text-align:right;\"> -1 </td>\n   <td style=\"text-align:right;\"> 48.451 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Interpretation of effect\n\n- Compliers are the individuals whose decision to attend college is influenced by the instrumental variable. In this study, compliers are the students who would attend college if they lived close to one and would not attend college if they lived far away. These students' decisions are directly impacted by the geographical distance to college.\n- Always-takers are the individuals who would attend college regardless of the geographical distance. These students would pursue higher education even if they lived far away from a college.\n\n# Sharp RD\n\n## RD plot\nWe can observe a clear difference around the cutoff.\n\n::: {.cell}\n\n```{.r .cell-code}\nsenate <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/senate.csv\",\n    setclass = \"tibble\"\n    ) %>% \n    mutate(cutoff = if_else(margin > 0, 1, 0))\n\nsenate %>% \n    ggplot(aes(x = margin, y = vote, color = as.factor(cutoff))) +\n    geom_point(\n        size = 1, \n        alpha = 0.5,\n        position = position_jitter(\n            width = 0, \n            height = 0.25\n        )\n    ) + \n    geom_smooth(\n        data = filter(senate, margin > 0),\n        aes(x = margin, y = vote),\n        method = \"lm\",\n        color = \"#8E8E93\"\n    ) +\n    geom_smooth(\n        data = filter(senate, margin < 0),\n        aes(x = margin, y = vote),\n        method = \"lm\",\n        color = \"#8E8E93\"\n    ) +\n    scale_color_manual(values = c(\"#FF7F50\", \"#00BFFF\")) +\n    geom_vline(\n        xintercept = 0,\n        linetype = \"dotdash\",\n        linewidth = 1\n    ) +\n    theme_clean() +\n    theme(\n        legend.position = \"none\"\n    ) +\n    xlab(\"Winning margin of a Democratic party senator\") +\n    ylab(\"Share of vote of the senator in election\")      \n```\n\n::: {.cell-output-display}\n![Raw RD plot](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrdplot(\n    y = senate$vote, \n    x = senate$margin, \n    nbins = 10,\n    x.label = \"Winning margin of a Democratic party senator\",\n    y.label = \"Share of vote of the senator in election\",\n    title = \"\"\n)\n```\n\n::: {.cell-output-display}\n![Binned RD plot](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n## Density Test\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndensity_plot <- rddensity(\n    senate$margin,\n    c = 0\n) %>% \nrdplotdensity(\n    rdd = .,\n    X = senate$margin,\n    type = \"both\"\n) %>% \npluck(\"Estplot\")\n```\n\n::: {.cell-output-display}\n![Density Test](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n## RD bandwidth selection\nThe obtained bandwidth is 24.969. We estimate the RD effect using three different bandwidth values (ideal, twice the ideal, and half of the ideal) to determine if the value is appropriate. As we can see, the coefficients change substantially. It is considered a big bandwidth since it includes more observations in our analysis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrdbwselect(\n    y = senate$vote,\n    x = senate$margin,\n    c = 0,\n    p = 3,\n    kernel = \"triangular\",\n    bwselect = \"mserd\"\n) %>% \npluck(\"bws\") %>% \nas_tibble() %>% \nset_names(\n    c(\"BW est left\", \"BW est right\", \"BW bias left\", \"BW bias right\")\n) %>% \nprint_kable(title = \"RD bandwidth selection\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>RD bandwidth selection</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> BW est left </th>\n   <th style=\"text-align:right;\"> BW est right </th>\n   <th style=\"text-align:right;\"> BW bias left </th>\n   <th style=\"text-align:right;\"> BW bias right </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 24.969 </td>\n   <td style=\"text-align:right;\"> 24.969 </td>\n   <td style=\"text-align:right;\"> 37.221 </td>\n   <td style=\"text-align:right;\"> 37.221 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrd_models <- c(24.969, 24.969 * 2, 24.969 / 2) %>% \n    map(~ rdrobust(\n        y = senate$vote,\n        x = senate$margin,\n        p = 3,\n        h = .\n        )\n    )\n\nextract_se_es <- \\(x) {\n    tibble(\n        \"Estimate\" = pluck(x, \"Estimate\")[1],\n        \"Se\" = pluck(x, \"se\")[1],\n        \"P-Value\" = pluck(x, \"pv\")[1]\n    )\n}\n\nrd_models %>% \n    map_dfr(extract_se_es) %>% \n    mutate(\n        Bandwidth = c(\n            \"24.969 (ideal)\", \n            \"49.938 (twice)\", \n            \"12.485 (half)\"\n        ),\n        .before = 1\n    ) %>% \n    print_kable(title = \"Sensitivity analysis using different bandwidths\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Sensitivity analysis using different bandwidths</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Bandwidth </th>\n   <th style=\"text-align:right;\"> Estimate </th>\n   <th style=\"text-align:right;\"> Se </th>\n   <th style=\"text-align:right;\"> P-Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 24.969 (ideal) </td>\n   <td style=\"text-align:right;\"> 9.126 </td>\n   <td style=\"text-align:right;\"> 2.314 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 49.938 (twice) </td>\n   <td style=\"text-align:right;\"> 7.676 </td>\n   <td style=\"text-align:right;\"> 1.781 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 12.485 (half) </td>\n   <td style=\"text-align:right;\"> 13.872 </td>\n   <td style=\"text-align:right;\"> 3.126 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Estimate Sharp RD treatment effect\nThe model result shows that there is an incumbency advantage.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsharp_rd <- rdrobust(\n    y = senate$vote,\n    x = senate$margin,\n    h = 24.96899,\n    p = 3\n) \n\ntibble(\n    \"Estimate\" = pluck(sharp_rd, \"Estimate\")[1],\n    \"Se\" = pluck(sharp_rd, \"se\")[1],\n    \"P-Value\" = pluck(sharp_rd, \"pv\")[1]\n) %>% \nprint_kable(title = \"Sharp RD treatment effect\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Sharp RD treatment effect</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> Estimate </th>\n   <th style=\"text-align:right;\"> Se </th>\n   <th style=\"text-align:right;\"> P-Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 9.126 </td>\n   <td style=\"text-align:right;\"> 2.314 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Varying orders of polynomial regression\nModels with different bandwidth all support the same conclusion.\n\n::: {.cell}\n\n```{.r .cell-code}\nc(1:4) %>% \n    map(~ rdrobust(\n        y = senate$vote,\n        x = senate$margin,\n        p = .,\n        h = 24.96899\n        )   \n    ) %>% \n    map_dfr(extract_se_es) %>% \n    mutate(\n        `Local-polynomial` = 1:4,\n        .before = 1 \n    ) %>% \n    print_kable(\"Varying orders of polynomial regression\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n<caption>Varying orders of polynomial regression</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> Local-polynomial </th>\n   <th style=\"text-align:right;\"> Estimate </th>\n   <th style=\"text-align:right;\"> Se </th>\n   <th style=\"text-align:right;\"> P-Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 7.103 </td>\n   <td style=\"text-align:right;\"> 1.264 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 7.854 </td>\n   <td style=\"text-align:right;\"> 1.797 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 9.126 </td>\n   <td style=\"text-align:right;\"> 2.314 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 11.556 </td>\n   <td style=\"text-align:right;\"> 2.882 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}